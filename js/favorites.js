/**
 * Favoriler √ñzelliƒüi
 * Kullanƒ±cƒ±larƒ±n men√º √∂ƒüelerini favorilere eklemelerini ve daha sonra g√∂r√ºnt√ºlemelerini saƒülar.
 */

document.addEventListener('DOMContentLoaded', () => {
    // Favoriler sistemi ayarlarƒ±
    setupFavoritesSystem();
    
    // Favoriler sekmesi ekle
    addFavoritesTab();
});

// Favorilere ekle/√ßƒ±kar butonunu her men√º √∂ƒüesine ekle
function setupFavoritesSystem() {
    // LocalStorage'da favoriler varsa al, yoksa bo≈ü array olu≈ütur
    const favorites = JSON.parse(localStorage.getItem('arMenuFavorites')) || [];
    
    // T√ºm men√º √∂ƒüelerine favori butonu ekle
    document.querySelectorAll('.menu-item').forEach(menuItem => {
        // Men√º √∂ƒüesinin ID'sini al
        const itemId = menuItem.dataset.itemId || generateItemId(menuItem);
        menuItem.dataset.itemId = itemId;
        
        // Favori butonu olu≈ütur
        const favoriteBtn = document.createElement('button');
        favoriteBtn.className = 'favorite-btn';
        favoriteBtn.innerHTML = favorites.includes(itemId) 
            ? '<i class="fas fa-heart"></i>' 
            : '<i class="far fa-heart"></i>';
        
        // Favori butonunu men√º √∂ƒüesinin i√ßine ekle
        const menuItemImg = menuItem.querySelector('.menu-item-img-container') || menuItem.querySelector('.menu-item-img').parentNode;
        menuItemImg.style.position = 'relative';
        menuItemImg.appendChild(favoriteBtn);
        
        // Favori butonu olayƒ±
        favoriteBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Butonun altƒ±ndaki √∂ƒüelere tƒ±klamayƒ± engelle
            toggleFavorite(itemId, favoriteBtn);
        });
    });
}

// Men√º √∂ƒüesi i√ßin benzersiz ID olu≈ütur
function generateItemId(menuItem) {
    const title = menuItem.querySelector('.menu-item-title').textContent;
    const price = menuItem.querySelector('.menu-item-price').textContent;
    return `${title.trim()}_${price.trim()}`.replace(/\s+/g, '_').replace(/[^a-z0-9_]/gi, '').toLowerCase();
}

// √ñƒüeyi favorilere ekle/√ßƒ±kar
function toggleFavorite(itemId, button) {
    let favorites = JSON.parse(localStorage.getItem('arMenuFavorites')) || [];
    
    const index = favorites.indexOf(itemId);
    if (index > -1) {
        // Favorilerden √ßƒ±kar
        favorites.splice(index, 1);
        button.innerHTML = '<i class="far fa-heart"></i>'; // Bo≈ü kalp ikonu
        showStatusMessage('Favorilerden √ßƒ±karƒ±ldƒ±');
    } else {
        // Favorilere ekle
        favorites.push(itemId);
        button.innerHTML = '<i class="fas fa-heart"></i>'; // Dolu kalp ikonu
        showStatusMessage('Favorilere eklendi');
        
        // Haptic feedback
        if (window.navigator && window.navigator.vibrate) {
            window.navigator.vibrate([50, 30, 50]);
        }
    }
    
    // Favorileri g√ºncelle
    localStorage.setItem('arMenuFavorites', JSON.stringify(favorites));
    
    // Eƒüer favoriler sekmesi mevcutsa, i√ßeriƒüini g√ºncelle
    updateFavoritesSection();
}

// Favoriler sekmesini ekle
function addFavoritesTab() {
    // √ñnce mevcut sekmeleri kontrol et
    const menuTabs = document.querySelector('.menu-tabs');
    if (!menuTabs || document.querySelector('.menu-tab[data-target="favorites"]')) return;
    
    // Favoriler sekmesi olu≈ütur
    const favoritesTab = document.createElement('a');
    favoritesTab.href = '#favoritesSection';
    favoritesTab.className = 'menu-tab';
    favoritesTab.setAttribute('data-target', 'favorites');
    favoritesTab.innerHTML = `
        <span class="tab-emoji">‚ù§Ô∏è</span> Favoriler
    `;
    
    // Sekmeyi ekle
    menuTabs.appendChild(favoritesTab);
    
    // Favoriler b√∂l√ºm√º olu≈ütur
    const favoritesSection = document.createElement('section');
    favoritesSection.id = 'favoritesSection';
    favoritesSection.className = 'menu-section';
    favoritesSection.innerHTML = `
        <h2 class="section-title">‚ù§Ô∏è Favorilerim</h2>
        <div class="menu-items" id="favoriteItems"></div>
    `;
    
    // Ana i√ßerik alanƒ±na ekle
    const mainContainer = document.querySelector('.main-container');
    mainContainer.appendChild(favoritesSection);
    
    // ƒ∞lk i√ßeriƒüi y√ºkle
    updateFavoritesSection();
    
    // Sekme tƒ±klama olayƒ±
    favoritesTab.addEventListener('click', (e) => {
        e.preventDefault();
        
        // Diƒüer sekmelerdeki active class'ƒ± kaldƒ±r
        document.querySelectorAll('.menu-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Bu sekmeye active class ekle
        favoritesTab.classList.add('active');
        
        // Favoriler b√∂l√ºm√ºne git
        favoritesSection.scrollIntoView({
            behavior: 'smooth'
        });
        
        // ƒ∞√ßeriƒüi g√ºncelle
        updateFavoritesSection();
    });
}

// Favoriler b√∂l√ºm√ºn√º g√ºncelle
function updateFavoritesSection() {
    const favoritesContainer = document.getElementById('favoriteItems');
    if (!favoritesContainer) return;
    
    // Favorileri local storage'dan al
    let favorites = JSON.parse(localStorage.getItem('arMenuFavorites')) || [];
    
    // Favoriler bo≈üsa mesaj g√∂ster
    if (favorites.length === 0) {
        favoritesContainer.innerHTML = `
            <div class="no-favorites">
                <div class="no-favorites-emoji">üíî</div>
                <h3 class="no-favorites-title">Hen√ºz favoriniz yok</h3>
                <p class="no-favorites-message">Favori √ºr√ºnlerinizi eklemek i√ßin men√º √∂ƒüelerindeki kalp ikonuna tƒ±klayƒ±n.</p>
            </div>
        `;
        return;
    }
    
    // Favorilere eklenen men√º √∂ƒüelerini g√∂ster
    favoritesContainer.innerHTML = '';
    favorites.forEach(itemId => {
        // ID ile men√º √∂ƒüesini bul
        const originalItem = document.querySelector(`.menu-item[data-item-id="${itemId}"]`);
        if (originalItem) {
            // Men√º √∂ƒüesini kopyala ve favorilere ekle
            const itemClone = originalItem.cloneNode(true);
            favoritesContainer.appendChild(itemClone);
            
            // Yeni favori butonuna tƒ±klama olayƒ± ekle
            const newFavoriteBtn = itemClone.querySelector('.favorite-btn');
            if (newFavoriteBtn) {
                newFavoriteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Hem orijinal hem de kopya butonu g√ºncelle
                    toggleFavorite(itemId, newFavoriteBtn);
                    const originalBtn = originalItem.querySelector('.favorite-btn');
                    if (originalBtn) {
                        originalBtn.innerHTML = newFavoriteBtn.innerHTML;
                    }
                });
            }
            
            // AR butonu i√ßin doƒüru olayƒ± ayarla
            const arButton = itemClone.querySelector('.menu-item-ar');
            if (arButton) {
                // Orijinal d√ºƒüme olaylarƒ±nƒ± kopyalayamayacaƒüƒ±mƒ±z i√ßin, item veri √∂zelliƒüini ekleyip
                // o men√º √∂ƒüesi i√ßin AR'ƒ± ba≈ülatan fonksiyonu √ßaƒüƒ±rƒ±yoruz
                arButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // Orijinal √∂ƒüenin ID'sine g√∂re menuData'dan √∂ƒüeyi bulalƒ±m
                    const menuItemData = findMenuItemById(itemId);
                    if (menuItemData) {
                        // AR g√∂r√ºnt√ºleyicisini ba≈ülat
                        if (arSupport === 'quicklook' && menuItemData.usdz) {
                            initQuickLook(menuItemData);
                        } else if (arSupport === 'webxr') {
                            initWebXR(menuItemData);
                        } else {
                            initModelViewer(menuItemData);
                        }
                    } else {
                        showStatusMessage('Bu √∂ƒüe i√ßin AR modeli bulunamadƒ±.');
                    }
                });
            }
        } else {
            // Eƒüer orijinal √∂ƒüe bulunamadƒ±ysa (muhtemelen silinmi≈ü veya deƒüi≈ümi≈ü bir √∂ƒüe)
            // Bu √∂ƒüeyi favorilerden kaldƒ±r
            console.warn(`Favorilerdeki √∂ƒüe bulunamadƒ±. ID: ${itemId}`);
            favorites = favorites.filter(id => id !== itemId);
            localStorage.setItem('arMenuFavorites', JSON.stringify(favorites));
        }
    });
}

// ID'ye g√∂re menuData i√ßinden √∂ƒüe bulma
function findMenuItemById(itemId) {
    let allMenuItems = [];
    
    // T√ºm kategorilerdeki √∂ƒüeleri topla
    for (const category in menuData) {
        if (Array.isArray(menuData[category])) {
            allMenuItems = [...allMenuItems, ...menuData[category]];
        }
    }
    
    // ID'ye g√∂re e≈üle≈üen √∂ƒüeyi bul
    for (const item of allMenuItems) {
        const generatedId = `${item.name.trim()}_${item.price.trim()}`.replace(/\s+/g, '_').replace(/[^a-z0-9_]/gi, '').toLowerCase();
        if (generatedId === itemId) {
            return item;
        }
    }
    
    return null;
}

// Favori sayƒ±sƒ±nƒ± g√ºncelleme ve sekme badge'ini g√ºncelleyen yardƒ±mcƒ± fonksiyon
function updateFavoritesCount() {
    const favorites = JSON.parse(localStorage.getItem('arMenuFavorites')) || [];
    const favoritesTab = document.querySelector('.menu-tab[data-target="favorites"]');
    
    if (favoritesTab) {
        // Mevcut badge'i bul veya olu≈ütur
        let badge = favoritesTab.querySelector('.tab-count');
        if (!badge && favorites.length > 0) {
            badge = document.createElement('span');
            badge.className = 'tab-count';
            favoritesTab.appendChild(badge);
        }
        
        // Badge i√ßeriƒüini g√ºncelle veya gizle
        if (badge) {
            if (favorites.length > 0) {
                badge.textContent = favorites.length;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
    }
}

// Sayfa y√ºklendiƒüinde ve her favori deƒüi≈üikliƒüinde sayƒ±yƒ± g√ºncelle
document.addEventListener('DOMContentLoaded', updateFavoritesCount);
window.addEventListener('storage', updateFavoritesCount); // Diƒüer sekmelerde yapƒ±lan deƒüi≈üiklikleri yakala